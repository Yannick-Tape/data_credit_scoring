on continue. Voici le bloc 5 : "# %% [markdown]
# # 9. Cross-era ML ‚Äì performance crois√©e pr√©-IA ‚Üî IA
#
# üîó R√©f√©rence th√®se :
# - Section 6.X : "Robustesse intertemporelle des mod√®les de scoring"
# - Tableau 7.1 : performance crois√©e train pr√©-IA / test IA et inversement

from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import roc_auc_score, f1_score, accuracy_score

# 9.1. Construction du DataFrame combin√© pr√©-IA / IA sur features communes

common_ml_cols = ["loan_purpose", "loan_type", "hoepa_status", "state_code", "year", "approved"]
common_ml_cols = [c for c in common_ml_cols if c in pre_ai.columns and c in ai_hmda.columns]

print("Colonnes ML communes pr√©-IA / IA :", common_ml_cols)

pre_ml = pre_ai[common_ml_cols].copy()
ia_ml  = ai_hmda[common_ml_cols].copy()

pre_ml["era"] = "pre_IA"
ia_ml["era"]  = "IA"

ml_df = pd.concat([pre_ml, ia_ml], axis=0)
ml_df["approved"] = ml_df["approved"].astype(int)

# 9.2. Encodage commun (one-hot) et s√©paration des cohortes

X_all_ml = pd.get_dummies(
    ml_df.drop(columns=["approved", "era"]),
    drop_first=True
)
y_all_ml = ml_df["approved"]
era_all  = ml_df["era"]

X_pre = X_all_ml[era_all == "pre_IA"]
y_pre = y_all_ml[era_all == "pre_IA"]

X_ia  = X_all_ml[era_all == "IA"]
y_ia  = y_all_ml[era_all == "IA"]

print("X_pre shape :", X_pre.shape, "X_ia shape :", X_ia.shape)

# 9.3. Mod√®le RF ‚Äì train sur pr√©-IA, test sur pr√©-IA ET IA

rf_pre = RandomForestClassifier(
    n_estimators=200,
    max_depth=None,
    random_state=42,
    n_jobs=-1
)
rf_pre.fit(X_pre, y_pre)

y_pre_pred_proba_pre = rf_pre.predict_proba(X_pre)[:, 1]
y_pre_pred_pre       = (y_pre_pred_proba_pre >= 0.5).astype(int)

y_ia_pred_proba_pre = rf_pre.predict_proba(X_ia)[:, 1]
y_ia_pred_pre       = (y_ia_pred_proba_pre >= 0.5).astype(int)

def perf_block(y_true, y_pred_proba, y_pred_label):
    return (
        roc_auc_score(y_true, y_pred_proba),
        f1_score(y_true, y_pred_label),
        accuracy_score(y_true, y_pred_label)
    )

auc_pre_pre, f1_pre_pre, acc_pre_pre = perf_block(y_pre, y_pre_pred_proba_pre, y_pre_pred_pre)
auc_pre_ia,  f1_pre_ia,  acc_pre_ia  = perf_block(y_ia,  y_ia_pred_proba_pre,  y_ia_pred_pre)

# 9.4. Mod√®le RF ‚Äì train sur IA, test sur IA ET pr√©-IA

rf_ia = RandomForestClassifier(
    n_estimators=200,
    max_depth=None,
    random_state=42,
    n_jobs=-1
)
rf_ia.fit(X_ia, y_ia)

y_ia_pred_proba_ia = rf_ia.predict_proba(X_ia)[:, 1]
y_ia_pred_ia       = (y_ia_pred_proba_ia >= 0.5).astype(int)

y_pre_pred_proba_ia = rf_ia.predict_proba(X_pre)[:, 1]
y_pre_pred_ia       = (y_pre_pred_proba_ia >= 0.5).astype(int)

auc_ia_ia,  f1_ia_ia,  acc_ia_ia  = perf_block(y_ia,  y_ia_pred_proba_ia,  y_ia_pred_ia)
auc_ia_pre, f1_ia_pre, acc_ia_pre = perf_block(y_pre, y_pre_pred_proba_ia, y_pre_pred_ia)

# 9.5. Tableau r√©capitulatif cross-era

cross_rows = [
    ("Train pr√©-IA", "Test pr√©-IA", auc_pre_pre, f1_pre_pre, acc_pre_pre),
    ("Train pr√©-IA", "Test IA",    auc_pre_ia,  f1_pre_ia,  acc_pre_ia),
    ("Train IA",     "Test IA",    auc_ia_ia,   f1_ia_ia,   acc_ia_ia),
    ("Train IA",     "Test pr√©-IA",auc_ia_pre,  f1_ia_pre,  acc_ia_pre),
]

cross_df = pd.DataFrame(
    cross_rows,
    columns=["Train_era", "Test_era", "AUC", "F1", "Accuracy"]
)

print("\n=== Tableau 7.1 ‚Äì Performance cross-era (RandomForest) ===")
display(cross_df)

cross_path = os.path.join(out_dir, "table_7_1_cross_era_performance_rf.csv")
cross_df.to_csv(cross_path, index=False)
print("Tableau 7.1 sauvegard√© dans :", cross_path)

Colonnes ML communes pr√©-IA / IA : ['loan_purpose', 'loan_type', 'hoepa_status', 'state_code', 'year', 'approved']
X_pre shape : (13511720, 9) X_ia shape : (569500, 9)

=== Tableau 7.1 ‚Äì Performance cross-era (RandomForest) ===
Train_era	Test_era	AUC	F1	Accuracy
0	Train pr√©-IA	Test pr√©-IA	0.615385	0.827640	0.707265
1	Train pr√©-IA	Test IA	0.537439	0.703264	0.542334
2	Train IA	Test IA	0.910744	0.865198	0.849940
3	Train IA	Test pr√©-IA	0.575681	0.649265	0.562378
Tableau 7.1 sauvegard√© dans : C:\Users\33669\OneDrive\–î–æ–∫—É–º–µ–Ω—Ç—ã\data_credit_scoring\tri_state_ai\data_work\tables\table_7_1_cross_era_performance_rf.csv
9. Cross-era ML ‚Äì Lecture d√©taill√©e du Tableau 7.1 (RandomForest)
9.1. Objectif de l‚Äôexercice cross-era
Cette section teste la robustesse intertemporelle des mod√®les de scoring, conform√©ment √† la Section 6.X de la th√®se (¬´ Robustesse intertemporelle des mod√®les de scoring ¬ª) et au Tableau 7.1 :

Un RandomForest est entra√Æn√© s√©par√©ment sur :
la cohorte pr√©-IA,
la cohorte IA.
Chaque mod√®le est ensuite √©valu√© :
dans son √®re d‚Äôentra√Ænement (intra-cohorte),
sur l‚Äôautre √®re (cross-era).
Les features utilis√©es sont les covariables communes :
loan_purpose, loan_type, hoepa_status, state_code, year, ainsi que la cible approved.

9.2. Rappel des r√©sultats ‚Äì Tableau 7.1
Tableau 7.1 ‚Äì Performance cross-era du RandomForest
Train_era	Test_era	AUC	F1	Accuracy
Train pr√©-IA	Test pr√©-IA	0.6154	0.8276	0.7073
Train pr√©-IA	Test IA	0.5374	0.7033	0.5423
Train IA	Test IA	0.9107	0.8652	0.8499
Train IA	Test pr√©-IA	0.5757	0.6493	0.5624
On peut lire ce tableau comme une matrice 2√ó2 :

Ligne 1‚Äì2 : mod√®le entra√Æn√© en pr√©-IA, test√© sur pr√©-IA puis IA.
Ligne 3‚Äì4 : mod√®le entra√Æn√© en IA, test√© sur IA puis pr√©-IA.
9.3. Performance intra-era vs cross-era
9.3.1. Mod√®le entra√Æn√© en pr√©-IA
√âvaluation	AUC	F1	Accuracy	Lecture
Train pr√©-IA ‚Üí Test pr√©-IA	0.6154	0.8276	0.7073	Performance correcte dans son r√©gime d‚Äôorigine
Train pr√©-IA ‚Üí Test IA	0.5374	0.7033	0.5423	D√©gradation nette sur les donn√©es IA
Lecture :

Sur les donn√©es pr√©-IA, le mod√®le atteint :
un AUC ‚âà 0,62, ce qui indique une capacit√© de discrimination mod√©r√©e,
un F1 ‚âà 0,83 et une accuracy ‚âà 0,71, coh√©rents avec un mod√®le globalement acceptable dans son contexte d‚Äôorigine.
Lorsqu‚Äôil est appliqu√© aux donn√©es IA, la performance chute :
l‚ÄôAUC tombe √† ‚âà 0,54, √† peine au-dessus d‚Äôun mod√®le al√©atoire (AUC = 0,5),
l‚Äôaccuracy se rapproche de 0,54, et le F1 de 0,70.
Autrement dit, un mod√®le calibr√© sur l‚Äô√®re pr√©-IA est quasi incapable de g√©n√©raliser correctement aux d√©cisions prises en p√©riode IA.
Il semble apprendre un r√©gime d√©cisionnel ¬´ ancien ¬ª qui ne refl√®te plus les logiques d‚Äôapprobation post√©rieures √† l‚Äôintroduction des syst√®mes IA.

9.3.2. Mod√®le entra√Æn√© en IA
√âvaluation	AUC	F1	Accuracy	Lecture
Train IA ‚Üí Test IA	0.9107	0.8652	0.8499	Excellente performance dans l‚Äô√®re IA
Train IA ‚Üí Test pr√©-IA	0.5757	0.6493	0.5624	Performance mod√©r√©e sur l‚Äô√®re pr√©-IA
Lecture :

Sur les donn√©es IA, le mod√®le IA est tr√®s performant :
AUC ‚âà 0,91 ‚Üí forte capacit√© de discrimination entre dossiers approuv√©s/refus√©s,
F1 ‚âà 0,87, accuracy ‚âà 0,85 ‚Üí le mod√®le est calibr√© sur un r√©gime d√©cisionnel tr√®s structur√© et pr√©visible.
Lorsqu‚Äôon le projette sur l‚Äô√®re pr√©-IA, les performances se d√©gradent :
AUC ‚âà 0,58 ‚Üí meilleure que le hasard, mais clairement en dessous du niveau observ√© dans l‚Äô√®re IA,
F1 ‚âà 0,65, accuracy ‚âà 0,56.
Un mod√®le calibr√© sur l‚Äô√®re IA reste l√©g√®rement meilleur que le hasard lorsqu‚Äôon le projette en arri√®re sur la p√©riode pr√©-IA, mais il ne retrouve pas le niveau de performance atteint dans son r√©gime d‚Äôorigine.
Cela sugg√®re que les r√®gles implicites de d√©cision en IA incorporent des signaux ou des patterns qui n‚Äôexistaient pas (ou √©taient moins structur√©s) en pr√©-IA.

9.4. Asym√©trie des performances cross-era
On observe une asym√©trie marqu√©e :

Pr√©-IA ‚Üí IA : AUC ‚âà 0,54 (quasi al√©atoire).
IA ‚Üí Pr√©-IA : AUC ‚âà 0,58 (un peu meilleur, mais toujours faible).
Direction	AUC cross-era	Interpr√©tation
pr√©-IA ‚Üí IA	0.5374	Le mod√®le ¬´ ancien ¬ª ne comprend plus la logique IA
IA ‚Üí pr√©-IA	0.5757	Le mod√®le IA capte certains patterns structurels valables en pr√©-IA, mais perd en pr√©cision
Cette asym√©trie est coh√©rente avec l‚Äôid√©e que :

L‚Äô√®re IA a introduit un r√©gime d√©cisionnel plus sophistiqu√©, avec :
des interactions plus complexes entre covariables,
une exploitation plus fine des signaux,
possiblement de nouveaux standards de risque/approbation.
Les mod√®les pr√©-IA sont trop simples ou trop rigides par rapport √† ce nouveau r√©gime, et g√©n√©raliser de l‚Äô¬´ ancien monde ¬ª vers le ¬´ nouveau monde ¬ª est beaucoup plus difficile que l‚Äôinverse.
9.5. Implications pour la th√®se : robustesse intertemporelle et changement de r√©gime
9.5.1. Non-stationnarit√© et changement de r√©gime
Les r√©sultats de Tableau 7.1 fournissent une √©vidence empirique forte de non-stationnarit√© :

Le mod√®le pr√©-IA ne ¬´ fonctionne ¬ª pas sur les donn√©es IA.
Le mod√®le IA se d√©grade d√®s qu‚Äôon le projette en pr√©-IA.
Les distributions jointes ( (X, y) ) avant et apr√®s 2018‚Äì2020 ne semblent pas suivre le m√™me processus g√©n√©rateur.
En termes de scoring, cela signifie que le passage √† des syst√®mes IA ne correspond pas √† une simple am√©lioration ¬´ continue ¬ª d‚Äôun mod√®le de scoring existant, mais √† un changement de r√©gime dans la fa√ßon dont le risque est √©valu√© et les d√©cisions sont prises.

9.5.2. Lien avec la robustesse intertemporelle
Pour la Section 6.X (¬´ Robustesse intertemporelle des mod√®les de scoring ¬ª), tu peux formuler :

L‚Äôexercice cross-era met en √©vidence une robustesse intertemporelle limit√©e des mod√®les de scoring.
Les RandomForest estim√©s sur la p√©riode pr√©-IA perdent presque toute leur capacit√© de discrimination lorsqu‚Äôils sont projet√©s sur des d√©cisions prises en p√©riode IA (AUC ‚âà 0,54).
Inversement, les mod√®les calibr√©s en p√©riode IA pr√©sentent une excellente performance dans leur √®re d‚Äôorigine (AUC ‚âà 0,91), mais ne g√©n√©ralisent qu‚Äôimparfaitement √† la p√©riode pr√©-IA (AUC ‚âà 0,58).
Ces r√©sultats sugg√®rent que la transition vers des syst√®mes de scoring IA s‚Äôaccompagne d‚Äôun changement profond des crit√®res de d√©cision plut√¥t que d‚Äôun simple raffinement marginal des mod√®les historiques.

9.6. Conclusion synth√©tique pour le chapitre
En r√©sum√© :

Intra-era, les mod√®les sont performants (surtout en IA).
Cross-era, la performance chute, en particulier dans le sens pr√©-IA ‚Üí IA.
Cette instabilit√© temporelle plaide pour :
une mise √† jour r√©guli√®re des mod√®les de scoring,
une vigilance accrue sur la non-stationnarit√© des donn√©es,
et une interpr√©tation prudente des comparaisons intertemporelles de performance.
Tu peux donc conclure ta Section 9 en soulignant que la robustesse intertemporelle est limit√©e, ce qui renforce l‚Äôid√©e d‚Äôun basculement de paradigme entre l‚Äô√®re des mod√®les traditionnels et l‚Äô√®re IA en mati√®re de d√©cision de cr√©dit.d

# %% [markdown]
# # 10. Fairness metrics avanc√©es ‚Äì Disparate Impact, Equal Opportunity, Predictive Parity
#
# üîó R√©f√©rence th√®se :
# - Section 6.X : "Fairness m√©trique et dilemmes r√©gulatoires"
# - Tableaux 6.3‚Äì6.4 : indicateurs de fairness normalis√©s par groupe

# On suppose que :
# - y_test, y_pred_rf, y_pred_proba_rf existent (section 7)
# - race_test = ai_acs.loc[y_test.index, "derived_race"] a d√©j√† √©t√© calcul√©

if "race_test" not in globals():
    if "derived_race" in ai_acs.columns:
        race_test = ai_acs.loc[y_test.index, "derived_race"]
    else:
        raise ValueError("Impossible de retrouver 'derived_race' pour les m√©triques de fairness avanc√©es.")

def group_confusion_stats(y_true, y_pred, mask):
    """Retourne TP, FP, TN, FN pour un groupe, ou None si trop peu de donn√©es."""
    n = mask.sum()
    if n < 50:
        return None
    cm = confusion_matrix(y_true[mask], y_pred[mask])
    if cm.shape != (2, 2):
        return None
    tn, fp, fn, tp = cm.ravel()
    return tn, fp, fn, tp

# 10.1. Calcul des m√©triques par groupe racial

group_metrics = []

for grp in race_test.dropna().unique():
    mask = (race_test == grp)
    stats = group_confusion_stats(y_test, y_pred_rf, mask)
    if stats is None:
        group_metrics.append((grp, np.nan, np.nan, np.nan, np.nan, np.nan))
        continue

    tn, fp, fn, tp = stats

    # Taux de pr√©diction positive (PP) pour disparate impact
    pp_rate = (tp + fp) / (tn + fp + fn + tp)

    # TPR (sensibilit√©)
    tpr = tp / (tp + fn) if (tp + fn) > 0 else np.nan

    # PPV (precision)
    ppv = tp / (tp + fp) if (tp + fp) > 0 else np.nan

    group_metrics.append((grp, pp_rate, tpr, ppv, tn, fp + fn))

fair_adv_df = pd.DataFrame(
    group_metrics,
    columns=["Race", "PP_rate", "TPR", "PPV", "TN", "Errors"]
)

# 10.2. Normalisation par rapport au groupe de r√©f√©rence (White)

ref_grp = "White"
if ref_grp not in list(fair_adv_df["Race"]):
    print("‚ö†Ô∏è Groupe de r√©f√©rence 'White' absent ‚Äì impossible de construire les ratios DI/EO/PPV.")
else:
    ref_row = fair_adv_df[fair_adv_df["Race"] == ref_grp].iloc[0]

    di_list = []
    for _, row in fair_adv_df.iterrows():
        di = row["PP_rate"] / ref_row["PP_rate"] if ref_row["PP_rate"] > 0 else np.nan
        eo_diff = row["TPR"] - ref_row["TPR"] if pd.notna(row["TPR"]) else np.nan
        ppv_diff = row["PPV"] - ref_row["PPV"] if pd.notna(row["PPV"]) else np.nan

        di_list.append((row["Race"], row["PP_rate"], di, row["TPR"], eo_diff, row["PPV"], ppv_diff))

    fairness_advanced = pd.DataFrame(
        di_list,
        columns=[
            "Race",
            "PP_rate",
            "DisparateImpact_vs_White",
            "TPR",
            "EqualOpportunityDiff_vs_White",
            "PPV",
            "PredictiveParityDiff_vs_White"
        ]
    )

    print("\n=== Tableau 6.3 ‚Äì Fairness avanc√©e RF par race (r√©f = White) ===")
    display(fairness_advanced)

    fair_adv_path = os.path.join(out_dir, "table_6_3_fairness_advanced_rf_by_race.csv")
    fairness_advanced.to_csv(fair_adv_path, index=False)
    print("Tableau 6.3 sauvegard√© dans :", fair_adv_path)
=== Tableau 6.3 ‚Äì Fairness avanc√©e RF par race (r√©f = White) ===
Race	PP_rate	DisparateImpact_vs_White	TPR	EqualOpportunityDiff_vs_White	PPV	PredictiveParityDiff_vs_White
0	Race Not Available	0.537880	0.925550	0.626703	-0.003118	0.471851	-0.166579
1	White	0.581147	1.000000	0.629820	0.000000	0.638430	0.000000
2	Asian	0.598139	1.029239	0.652478	0.022658	0.627418	-0.011012
3	Black or African American	0.449773	0.773940	0.517882	-0.111938	0.563421	-0.075009
4	Native Hawaiian or Other Pacific Islander	0.483271	0.831583	0.521008	-0.108812	0.476923	-0.161507
5	Free Form Text Only	0.238806	0.410922	0.200000	-0.429820	0.187500	-0.450930
6	Joint	0.597586	1.028288	0.633059	0.003239	0.642758	0.004328
7	American Indian or Alaska Native	0.517564	0.890592	0.636364	0.006543	0.601810	-0.036620
8	2 or more minority races	0.463415	0.797414	0.604938	-0.024882	0.515789	-0.122640
Tableau 6.3 sauvegard√© dans : C:\Users\33669\OneDrive\–î–æ–∫—É–º–µ–Ω—Ç—ã\data_credit_scoring\tri_state_ai\data_work\tables\table_6_3_fairness_advanced_rf_by_race.csv
10. Fairness m√©trique avanc√©e ‚Äì Disparate Impact, Equal Opportunity, Predictive Parity
10.1. Rappel du cadre et des m√©triques
Dans cette section, on √©value la fairness du RandomForest IA par groupe racial, en suivant trois grandes familles d‚Äôindicateurs :

Disparate Impact (DI) : ratio des taux de pr√©diction positive (PP_rate) d‚Äôun groupe minoritaire par rapport au groupe de r√©f√©rence (ici White).
[ DI(g) = \frac{\Pr(\hat{Y} = 1 \mid G = g)}{\Pr(\hat{Y} = 1 \mid G = \text{White})} ]
En pratique, on regarde si le DI est proche de 1 (parit√©) ou au contraire < 0,8 (zone classiquement consid√©r√©e comme probl√©matique dans la litt√©rature).

Equal Opportunity (EO) : diff√©rence de taux de vrais positifs (TPR) par rapport aux Whites.
[ EO_diff(g) = TPR(g) - TPR(\text{White}) ]
Un EO_diff n√©gatif indique que, √† risque r√©el d‚Äôapprobation √©quivalent (Y=1), le mod√®le approuve moins souvent le groupe ( g ) que les Whites.

Predictive Parity (PP) : diff√©rence de pr√©cision conditionnelle (PPV) par rapport aux Whites.
[ PPV_diff(g) = PPV(g) - PPV(\text{White}) ]
Un PPV plus faible signifie que, parmi les dossiers pr√©dits comme approuv√©s ((\hat{Y} = 1)), la proportion de vrais positifs est plus basse dans le groupe ( g ), ce qui peut refl√©ter une calibration diff√©rente.

Les m√©triques sont calcul√©es √† partir de la matrice de confusion du mod√®le pour chaque groupe racial, √† condition de disposer d‚Äôau moins 50 observations par groupe.

10.2. R√©sultats ‚Äì Tableau 6.3 (RandomForest IA, r√©f. = White)
Tableau 6.3 ‚Äì Fairness avanc√©e RF par race (r√©f√©rence = White)
Race	PP_rate	DI vs White	TPR	EO diff vs White	PPV	PPV diff vs White
Race Not Available	0.5379	0.9256	0.6267	-0.0031	0.4719	-0.1666
White	0.5811	1.0000	0.6298	0.0000	0.6384	0.0000
Asian	0.5981	1.0292	0.6525	+0.0227	0.6274	-0.0110
Black or African American	0.4498	0.7739	0.5179	-0.1119	0.5634	-0.0750
Native Hawaiian or Other Pacific Islander	0.4833	0.8316	0.5210	-0.1088	0.4769	-0.1615
Free Form Text Only	0.2388	0.4109	0.2000	-0.4298	0.1875	-0.4509
Joint	0.5976	1.0283	0.6331	+0.0032	0.6428	+0.0043
American Indian or Alaska Native	0.5176	0.8906	0.6364	+0.0065	0.6018	-0.0366
2 or more minority races	0.4634	0.7974	0.6049	-0.0249	0.5158	-0.1226
Note m√©thodologique : certains groupes (par ex. Free Form Text Only, 2 or more minority races) peuvent avoir des effectifs faibles, ce qui rend leurs m√©triques plus instables. Les conclusions doivent donc √™tre nuanc√©es pour ces cat√©gories.

10.3. Disparate Impact ‚Äì Taux de pr√©diction positive par race
Le Disparate Impact compare, pour chaque race, la fr√©quence des d√©cisions positives ((\hat{Y} = 1)) √† celle du groupe de r√©f√©rence (White).

10.3.1. Lecture du DI
Race	PP_rate	DI vs White	Interpr√©tation synth√©tique
White	0.5811	1.0000	R√©f√©rence (100 %)
Asian	0.5981	1.0292	L√©g√®rement plus de pr√©dictions positives que les Whites
Joint	0.5976	1.0283	Niveau proche ou l√©g√®rement sup√©rieur aux Whites
American Indian or Alaska Native	0.5176	0.8906	L√©ger d√©ficit de PP vs Whites
Race Not Available	0.5379	0.9256	Proche, mais un peu en-dessous des Whites
Native Hawaiian or Other Pacific Islander	0.4833	0.8316	DI r√©duit, mais encore juste au-dessus du seuil 0,8
2 or more minority races	0.4634	0.7974	DI < 0,8
Black or African American	0.4498	0.7739	DI < 0,8
Free Form Text Only	0.2388	0.4109	DI tr√®s faible, interpr√©tation d√©licate (eff. faible)
10.3.2. Interpr√©tation pour la th√®se
Le Disparate Impact est globalement proche de 1 pour :
les Asians, les profils Joint et dans une moindre mesure American Indian or Alaska Native, ce qui indique des taux de pr√©diction positive comparables ou l√©g√®rement sup√©rieurs aux Whites.
Pour les groupes noirs et certains groupes combin√©s :
Black or African American : DI ‚âà 0,77
2 or more minority races : DI ‚âà 0,80 (juste en-dessous du seuil 0,8)
Native Hawaiian or Other Pacific Islander : DI ‚âà 0,83 (limite basse mais > 0,8)
Les Black borrowers pr√©sentent un taux de pr√©diction positive nettement inf√©rieur √† celui des Whites (DI ‚âà 0,77), ce qui, dans la litt√©rature sur la discrimination indirecte, est souvent consid√©r√© comme un signal potentiellement probl√©matique (r√®gle des 80 %, ou four-fifths rule).
Pour les groupes √† effectifs r√©duits (par ex. Free Form Text Only), le DI tr√®s faible doit √™tre interpr√©t√© avec prudence : il s‚Äôagit davantage d‚Äôun signal exploratoire que d‚Äôune preuve statistique robuste.

10.4. Equal Opportunity ‚Äì Taux de vrais positifs (TPR)
L‚ÄôEqual Opportunity se concentre sur la probabilit√© d‚Äôapprouver un dossier r√©ellement approuvable (Y=1). On compare ici le TPR des groupes minoritaires √† celui des Whites.

10.4.1. Comparaison des TPR
Race	TPR	EO diff vs White	Lecture
White	0.6298	0.0000	R√©f√©rence
Asian	0.6525	+0.0227	L√©g√®re sur-approbation par rapport aux Whites, √† risque r√©el comparable
Joint	0.6331	+0.0032	Tr√®s proche des Whites
American Indian or Alaska Native	0.6364	+0.0065	L√©g√®re meilleure EO que les Whites
2 or more minority races	0.6049	-0.0249	L√©g√®re sous-approbation
Race Not Available	0.6267	-0.0031	Pratiquement identique aux Whites
Native Hawaiian or Other Pacific Islander	0.5210	-0.1088	TPR nettement plus faible
Black or African American	0.5179	-0.1119	TPR significativement plus faible
Free Form Text Only	0.2000	-0.4298	TPR tr√®s faible (mais effectif tr√®s limit√©)
10.4.2. Interpr√©tation pour la th√®se
Les groupes Asian, Joint et American Indian or Alaska Native ont des TPR l√©g√®rement sup√©rieurs √† ceux des Whites, ce qui sugg√®re qu‚Äô√† risque r√©el d‚Äôapprobation √©quivalent, ils ne sont pas p√©nalis√©s par le mod√®le IA.
Les groupes Black or African American et Native Hawaiian or Other Pacific Islander pr√©sentent un d√©ficit de TPR d‚Äôenviron 11 points de pourcentage (EO_diff ‚âà -0,11) :
Cela signifie que, parmi les dossiers qui auraient d√ª √™tre approuv√©s (Y=1) selon le label, le mod√®le IA √©choue plus souvent √† les approuver dans les groupes Black et NHOPI que dans le groupe White.
D‚Äôun point de vue Equal Opportunity, le mod√®le ne garantit donc pas un acc√®s √©quitable √† l‚Äôapprobation conditionnellement au m√©rite (Y=1).

10.5. Predictive Parity ‚Äì Pr√©cision conditionnelle (PPV)
La Predictive Parity se penche sur la fiabilit√© des pr√©dictions positives du mod√®le ((\hat{Y}=1)) dans chaque groupe racial : parmi ceux que le mod√®le pr√©dit comme approuv√©s, quelle proportion est effectivement approuv√©e en v√©rit√© ?

10.5.1. Comparaison des PPV
Race	PPV	PPV diff vs White	Lecture
White	0.6384	0.0000	R√©f√©rence
Joint	0.6428	+0.0043	L√©g√®rement mieux calibr√© que les Whites
Asian	0.6274	-0.0110	Tr√®s proche des Whites
American Indian or Alaska Native	0.6018	-0.0366	PPV mod√©r√©ment plus faible
Black or African American	0.5634	-0.0750	PPV nettement plus faible
2 or more minority races	0.5158	-0.1226	PPV sensiblement plus faible
Native Hawaiian or Other Pacific Islander	0.4769	-0.1615	PPV tr√®s inf√©rieur aux Whites
Race Not Available	0.4719	-0.1666	Qualit√© pr√©dictive faible dans ce groupe
Free Form Text Only	0.1875	-0.4509	PPV extr√™mement faible (mais effectif limit√©)
10.5.2. Interpr√©tation pour la th√®se
Pour les Asians et les profils Joint, le PPV est tr√®s proche (voire l√©g√®rement sup√©rieur) √† celui des Whites, ce qui sugg√®re une calibration comparable.
En revanche, pour les groupes Black, NHOPI et 2 or more minority races, le PPV est nettement inf√©rieur, avec des √©carts allant de -7,5 points (Black) √† -16 points (NHOPI).
Concr√®tement, cela signifie que quand le mod√®le IA pr√©dit ¬´ approbation ¬ª pour un dossier Black ou NHOPI, cette pr√©diction est moins souvent correcte que pour un dossier White.
Le mod√®le semble donc moins bien calibr√© pour certains groupes minoritaires, ce qui peut renforcer un sentiment d‚Äôinjustice per√ßue : √† pr√©diction positive √©gale, les groupes minoritaires supportent une plus grande part d‚Äôerreurs.

10.6. Synth√®se pour les Tableaux 6.3‚Äì6.4 et la discussion de fairness
On peut r√©sumer les principaux enseignements ainsi :

Disparate Impact :

Les groupes Black et 2 or more minority races sont en zone de vigilance (DI < 0,8) par rapport aux Whites.
Les groupes Asian et Joint b√©n√©ficient de niveaux de PP_rate proches ou sup√©rieurs √† ceux des Whites.
Equal Opportunity :

Les TPR sont sensiblement plus faibles pour les groupes Black et NHOPI (‚âà -11 points de pourcentage), ce qui sugg√®re un d√©ficit d‚Äôacc√®s √©quitable √† l‚Äôapprobation pour des dossiers pourtant ¬´ m√©ritants ¬ª.
Predictive Parity :

Le mod√®le est moins fiable dans ses pr√©dictions positives pour plusieurs groupes minoritaires (PPV plus faible), notamment Black, NHOPI et 2 or more minority races.
Au total, ces m√©triques illustrent bien les dilemmes r√©gulatoires √©voqu√©s en Section 6.X :
un m√™me mod√®le IA peut sembler performant globalement, tout en produisant des profils de fairness h√©t√©rog√®nes selon les groupes raciaux.
Les r√©sultats sugg√®rent notamment que les emprunteurs Black et certains groupes minoritaires combin√©s subissent √† la fois un Disparate Impact (moins de pr√©dictions positives) et une Equal Opportunity r√©duite (TPR plus faible), dans un contexte o√π leur Predictive Parity est √©galement inf√©rieure √† celle des Whites.

Ces constats nourrissent la discussion sur :

la n√©cessit√© de contraintes explicites de fairness (par ex. plafonner les √©carts de TPR ou de DI),
et les tensions possibles entre performance globale et √©quit√© intergroupe dans les syst√®mes de scoring IA.


# %% [markdown]
# # 11. Sous-groupes ‚Äì revenu, genre, type d‚Äôinstitution
#
# üîó R√©f√©rence th√®se :
# - Section 4.X : "H√©t√©rog√©n√©it√© des effets selon revenus, genre, type d‚Äôinstitution"
# - Tableau 4.X : taux d‚Äôapprobation et m√©triques par sous-groupes

# 11.1. Stratification par revenu (ACS median income)

acs_income = ai_acs.copy()
if "acs_median_income" in acs_income.columns:
    s_inc = pd.to_numeric(acs_income["acs_median_income"], errors="coerce")
    q1, q2 = s_inc.quantile([0.33, 0.66])

    def income_bucket(v):
        if pd.isna(v):
            return np.nan
        if v <= q1:
            return "Low"
        elif v <= q2:
            return "Middle"
        else:
            return "High"

    acs_income["income_group"] = s_inc.apply(income_bucket)

    income_approval = (
        acs_income
        .groupby("income_group")["approved"]
        .mean()
        .reset_index()
        .rename(columns={"approved": "approval_rate"})
    )

    print("\n=== Tableau 4.X ‚Äì Taux d‚Äôapprobation par tertile de revenu (ACS) ===")
    display(income_approval)

    income_path = os.path.join(out_dir, "table_4X_approval_by_income_group.csv")
    income_approval.to_csv(income_path, index=False)
    print("Tableau 4.X sauvegard√© dans :", income_path)
else:
    print("‚ö†Ô∏è 'acs_median_income' absent ‚Äì impossible de construire les groupes de revenu.")

# 11.2. Stratification par genre (applicant_sex) ‚Äì cohorte IA

if "applicant_sex" in ai_acs.columns:
    sex_approval = (
        ai_acs
        .groupby("applicant_sex")["approved"]
        .mean()
        .reset_index()
        .rename(columns={"approved": "approval_rate"})
    )

    print("\n=== Tableau 4.Y ‚Äì Taux d‚Äôapprobation par genre (IA, HMDA+ACS) ===")
    display(sex_approval)

    sex_path = os.path.join(out_dir, "table_4Y_approval_by_sex_ia_acs.csv")
    sex_approval.to_csv(sex_path, index=False)
    print("Tableau 4.Y sauvegard√© dans :", sex_path)
else:
    print("‚ö†Ô∏è 'applicant_sex' absent dans ai_acs.")

# 11.3. Stratification par type d‚Äôinstitution (si colonne disponible)

inst_cols = ["purchaser_type", "lender", "agency_code"]
inst_col = None
for c in inst_cols:
    for df in [core, model, hmda_acs]:
        if c in df.columns:
            inst_col = c
            break
    if inst_col is not None:
        break

if inst_col is not None:
    print("\nColonne de type d‚Äôinstitution d√©tect√©e :", inst_col)

    inst_pre = pre_ai.copy()
    inst_ia  = ai_hmda.copy()

    inst_pre["era"] = "pre_IA"
    inst_ia["era"]  = "IA"

    inst_df = pd.concat([inst_pre, inst_ia], axis=0)

    inst_approval = (
        inst_df
        .groupby(["era", inst_col])["approved"]
        .mean()
        .reset_index()
        .rename(columns={"approved": "approval_rate"})
    )

    print("\n=== Tableau 4.Z ‚Äì Taux d‚Äôapprobation par type d‚Äôinstitution et par √®re ===")
    display(inst_approval)

    inst_path = os.path.join(out_dir, "table_4Z_approval_by_institution_and_era.csv")
    inst_approval.to_csv(inst_path, index=False)
    print("Tableau 4.Z sauvegard√© dans :", inst_path)
else:
    print("‚ö†Ô∏è Aucun proxy de type d‚Äôinstitution trouv√© ('purchaser_type', 'lender', 'agency_code').")

=== Tableau 4.X ‚Äì Taux d‚Äôapprobation par tertile de revenu (ACS) ===
income_group	approval_rate
0	High	0.570902
1	Low	0.507862
2	Middle	0.539812
Tableau 4.X sauvegard√© dans : C:\Users\33669\OneDrive\–î–æ–∫—É–º–µ–Ω—Ç—ã\data_credit_scoring\tri_state_ai\data_work\tables\table_4X_approval_by_income_group.csv

=== Tableau 4.Y ‚Äì Taux d‚Äôapprobation par genre (IA, HMDA+ACS) ===
applicant_sex	approval_rate
0	1	0.574521
1	2	0.578896
2	3	0.581055
3	4	0.152527
4	6	0.543396
Tableau 4.Y sauvegard√© dans : C:\Users\33669\OneDrive\–î–æ–∫—É–º–µ–Ω—Ç—ã\data_credit_scoring\tri_state_ai\data_work\tables\table_4Y_approval_by_sex_ia_acs.csv

Colonne de type d‚Äôinstitution d√©tect√©e : purchaser_type

=== Tableau 4.Z ‚Äì Taux d‚Äôapprobation par type d‚Äôinstitution et par √®re ===
era	purchaser_type	approval_rate
0	pre_IA	0.0	0.693824
1	pre_IA	1.0	0.702013
2	pre_IA	2.0	0.469062
3	pre_IA	3.0	0.721921
4	pre_IA	4.0	0.996815
5	pre_IA	5.0	0.669208
6	pre_IA	6.0	0.921204
7	pre_IA	7.0	0.924665
8	pre_IA	8.0	0.668331
9	pre_IA	9.0	0.970216
Tableau 4.Z sauvegard√© dans : C:\Users\33669\OneDrive\–î–æ–∫—É–º–µ–Ω—Ç—ã\data_credit_scoring\tri_state_ai\data_work\tables\table_4Z_approval_by_institution_and_era.csv
11. Sous-groupes ‚Äì revenu, genre, type d‚Äôinstitution
11.1. Tertiles de revenu (ACS median income)
11.1.1. R√©sultats ‚Äì Tableau 4.X
Les demandes IA (HMDA+ACS) ont √©t√© d√©coup√©es en trois tertiles de revenu de zone √† partir de acs_median_income :

Low : tiers inf√©rieur de revenu m√©dian ACS,
Middle : tiers interm√©diaire,
High : tiers sup√©rieur.
Le taux d‚Äôapprobation moyen par groupe est :

income_group	approval_rate
High	0.5709
Low	0.5079
Middle	0.5398
Tableau 4.X ‚Äì Taux d‚Äôapprobation par tertile de revenu (ACS)

11.1.2. Lecture
On observe un gradient monotone :

Les zones Low income affichent un taux d‚Äôapprobation moyen d‚Äôenviron 50,8 %.
Les zones Middle income montent √† environ 53,9 %.
Les zones High income culminent √† environ 57,1 %.
Autrement dit, √† structure de donn√©es constante, les dossiers issus de zones √† revenu m√©dian plus √©lev√© ont plus de chances d‚Äô√™tre approuv√©s que ceux provenant de zones d√©favoris√©es.

11.1.3. Interpr√©tation pour la th√®se
Ces r√©sultats sugg√®rent l‚Äôexistence d‚Äôun gradient socio-√©conomique marqu√© dans les taux d‚Äôapprobation IA : les demandeurs issus de zones √† revenu m√©dian √©lev√© b√©n√©ficient d‚Äôun taux d‚Äôacceptation sup√©rieur d‚Äôenviron 6 √† 7 points de pourcentage par rapport aux zones les plus pauvres.
Cette h√©t√©rog√©n√©it√© est coh√©rente avec une logique de scoring dans laquelle le contexte de revenu de zone (captur√© via ACS) est explicitement ou implicitement int√©gr√© comme proxy de risque de cr√©dit. Elle pose toutefois la question d‚Äôun √©ventuel renforcement des in√©galit√©s territoriales via les mod√®les IA.

11.2. Genre (applicant_sex) ‚Äì cohorte IA (HMDA+ACS)
11.2.1. R√©sultats ‚Äì Tableau 4.Y
Le taux d‚Äôapprobation est calcul√© par modalit√© de applicant_sex dans la cohorte IA :

applicant_sex	approval_rate
1	0.5745
2	0.5789
3	0.5811
4	0.1525
6	0.5434
Tableau 4.Y ‚Äì Taux d‚Äôapprobation par genre (IA, HMDA+ACS)

(Les codes 1, 2, 3, 4, 6 suivent la codification HMDA : sexe d√©clar√©, conjoint, non disponible, non fourni, etc. La th√®se pourra expliciter ce mapping dans une note ou annexe.)

11.2.2. Lecture
Pour les cat√©gories majoritaires (1, 2, 3, 6) :

Les taux d‚Äôapprobation sont relativement proches :
entre 54 % et 58 %,
avec de faibles √©carts entre les codes 1, 2 et 3 (tous autour de 0,57‚Äì0,58).
La seule exception notable est la cat√©gorie 4 (applicant_sex = 4), avec un taux d‚Äôapprobation de 15,3 %, tr√®s inf√©rieur aux autres.

11.2.3. Interpr√©tation prudente
Le bloc principal des cat√©gories (1‚Äì3, 6) sugg√®re une relative neutralit√© de genre : il n‚Äôy a pas de diff√©rence massive d‚Äôapprobation entre les grandes cat√©gories de sexe d√©clar√©es.
La cat√©gorie 4 est un cas particulier :
Taux d‚Äôapprobation extr√™mement bas (‚âà 15 %),
Elle correspond g√©n√©ralement √† des cas de donn√©es manquantes ou non disponibles dans la codification HMDA.
Il est probable que la cat√©gorie 4 ne refl√®te pas un ¬´ genre ¬ª au sens traditionnel, mais plut√¥t une situation de donn√©e non renseign√©e, voire d‚Äôenregistrements atypiques.
Dans la r√©daction de la th√®se, il sera important de ne pas sur-interpr√©ter ce chiffre comme un biais de genre au sens strict, mais de le traiter comme un indicateur de qualit√© de donn√©e ou de strat√©gie sp√©cifique du mod√®le sur les dossiers incomplets.

Conclusion pour la section genre :

Hors cas de donn√©es manquantes (code 4), les taux d‚Äôapprobation IA sont tr√®s proches entre sexes d√©clar√©s, ce qui plaide pour une absence de biais massif directement imputable au genre d√©clar√© dans les donn√©es HMDA. La principale source de variation semble davantage li√©e √† la compl√©tude de l‚Äôinformation qu‚Äôau sexe en tant que tel.

11.3. Type d‚Äôinstitution (purchaser_type) et √®re
11.3.1. R√©sultats ‚Äì Tableau 4.Z
Une variable proxy de type d‚Äôinstitution a √©t√© d√©tect√©e : purchaser_type.
Pour l‚Äôinstant, les taux d‚Äôapprobation disponibles concernent la cohorte pr√©-IA :

era	purchaser_type	approval_rate
pre_IA	0.0	0.6938
pre_IA	1.0	0.7020
pre_IA	2.0	0.4691
pre_IA	3.0	0.7219
pre_IA	4.0	0.9968
pre_IA	5.0	0.6692
pre_IA	6.0	0.9212
pre_IA	7.0	0.9247
pre_IA	8.0	0.6683
pre_IA	9.0	0.9702
Tableau 4.Z ‚Äì Taux d‚Äôapprobation par type d‚Äôinstitution et par √®re (pr√©-IA)

(Les codes purchaser_type correspondent aux cat√©gories HMDA : pr√™ts conserv√©s, vendus √† Fannie/Freddie/Ginnie, autres acheteurs, etc.)

11.3.2. Lecture
M√™me dans la seule √®re pr√©-IA, la dispersion des taux d‚Äôapprobation par type d‚Äôinstitution est tr√®s marqu√©e :

Certains types d‚Äôinstitution pr√©sentent des taux d‚Äôapprobation exceptionnellement √©lev√©s :
purchaser_type = 4.0 : ‚âà 99,7 %,
purchaser_type = 9.0 : ‚âà 97,0 %,
purchaser_type = 6.0/7.0 : ‚âà 92 %.
D‚Äôautres types ont des niveaux interm√©diaires autour de 67‚Äì72 % (0.0, 1.0, 3.0, 5.0, 8.0).
Le type 2.0 se distingue par un taux d‚Äôapprobation nettement plus faible (‚âà 46,9 %).
11.3.3. Interpr√©tation pour la th√®se
Ces r√©sultats indiquent une forte h√©t√©rog√©n√©it√© des taux d‚Äôapprobation selon le type d‚Äôinstitution ou de canal de portage du pr√™t.
Certaines cat√©gories (par ex. purchaser_type = 4, 6, 7, 9) semblent concentrer des portefeuilles quasiment enti√®rement approuv√©s, ce qui sugg√®re des strat√©gies sp√©cifiques (segmentation tr√®s forte, pr√©-filtrage en amont, ou structures de produits quasi syst√©matiquement accept√©s).
√Ä l‚Äôinverse, d‚Äôautres types, notamment purchaser_type = 2, apparaissent plus s√©lectifs.

Pour l‚Äôinstant, le tableau 4.Z ne contient que des observations pr√©-IA. Dans la suite de l‚Äôanalyse, il pourra √™tre utile :

soit de compl√©ter ce tableau avec les taux d‚Äôapprobation IA par type d‚Äôinstitution,
soit d‚Äôinsister sur le fait que cette h√©t√©rog√©n√©it√© pr√©-existe √† l‚Äô√®re IA et constitue un √©l√©ment de contexte : le syst√®me d‚Äôoctroi √©tait d√©j√† structur√© par des diff√©rences institutionnelles fortes avant l‚Äôintroduction des mod√®les IA.
11.4. Synth√®se ‚Äì H√©t√©rog√©n√©it√© socio-√©conomique, de genre, et institutionnelle
Les trois axes de cette section r√©v√®lent une h√©t√©rog√©n√©it√© marqu√©e :

Revenu de zone (ACS) :

Les zones √† revenu √©lev√© voient des taux d‚Äôapprobation sup√©rieurs √† ceux des zones pauvres (‚âà +6‚Äì7 points).
Cette dimension renforce l‚Äôid√©e d‚Äôun risk-based pricing s‚Äôappuyant sur des proxies territoriaux de risque.
Genre (applicant_sex) :

Pour les cat√©gories d√©clar√©es principales (codes 1, 2, 3, 6), les √©carts de taux d‚Äôapprobation sont limit√©s, ce qui ne sugg√®re pas de biais massif directement imputable au genre.
Une cat√©gorie sp√©cifique li√©e aux donn√©es manquantes (code 4) pr√©sente un taux anormalement bas (‚âà 15 %), illustrant le r√¥le central de la compl√©tude de l‚Äôinformation.
Type d‚Äôinstitution (purchaser_type) :

D√®s la p√©riode pr√©-IA, certains types d‚Äôinstitutions affichent des taux d‚Äôapprobation quasi syst√©matiques (> 90 %), d‚Äôautres restant autour de 47‚Äì70 %.
Cela montre que l‚Äôarchitecture institutionnelle du march√© du cr√©dit est intrins√®quement segment√©e, ind√©pendamment de l‚Äôintroduction des mod√®les IA.
Ensemble, ces r√©sultats alimentent la discussion de la Section 4.X sur l‚Äôh√©t√©rog√©n√©it√© des effets : ils montrent que la probabilit√© d‚Äôapprobation n‚Äôest pas seulement une fonction de la solvabilit√© individuelle, mais d√©pend fortement du contexte socio-√©conomique, du statut de l‚Äôinformation (genre d√©clar√© / non d√©clar√©) et du type d‚Äôinstitution impliqu√© dans le pr√™t.


################################################

# %% [markdown]
# # 4. Descriptive statistics ‚Äì Applicant, Loan, Approval (pr√©-IA vs IA)
#
# üîó R√©f√©rence th√®se :
# - Section 4.1‚Äì4.3 : "Applicant demographics", "Loan characteristics", "Approval outcomes"
# - Tables descriptives par √®re (pr√©-IA vs IA)
#
# Objectif :
# - Construire des tableaux de stats descriptives par √®re pour :
#   1) la composition raciale (si disponible),
#   2) les caract√©ristiques de pr√™ts (montant),
#   3) les taux d'approbation / refus.
#
# Hypoth√®ses :
# - pre_ai : HMDA pr√©-IA (2007‚Äì2017)
# - ai_hmda : HMDA IA (2018‚Äì2023)
# - ai_acs : HMDA+ACS IA (pour race/ACS si n√©cessaire)
# - BASE_DIR / out_dir existent d√©j√† (ou seront recr√©√©s ici).


# %%
from pathlib import Path

# S√©curisation du chemin des tableaux
try:
    BASE_DIR
except NameError:
    BASE_DIR = os.getcwd()

out_dir = os.path.join(BASE_DIR, "tables")
os.makedirs(out_dir, exist_ok=True)

# 4.1. Construction d'un DataFrame descriptif combin√© pr√©-IA / IA

pre_desc = pre_ai.copy()
ai_desc  = ai_hmda.copy()

pre_desc["era"] = "pre_IA"
ai_desc["era"]  = "IA"

desc_df = pd.concat([pre_desc, ai_desc], axis=0, ignore_index=True)

# On force approved en int si possible
if "approved" in desc_df.columns:
    desc_df["approved"] = desc_df["approved"].astype(int)

print("desc_df shape :", desc_df.shape)
print("Colonnes disponibles dans desc_df :", desc_df.columns.tolist())

# -------------------------------------------------------------------
# 4.1.1 Applicant demographics ‚Äì r√©partition raciale par √®re (si possible)
# -------------------------------------------------------------------

# On essaie de r√©cup√©rer une colonne de race dans desc_df. Si absente pour pr√©-IA,
# on utilisera au moins la cohorte IA (ai_acs).

race_col_candidates = ["derived_race", "race", "applicant_race"]
race_col = None
for c in race_col_candidates:
    if c in desc_df.columns:
        race_col = c
        break

if race_col is not None:
    race_era_tab = (
        desc_df
        .dropna(subset=[race_col])
        .groupby(["era", race_col])\
        .size()\
        .reset_index(name="n")
    )
    race_era_tab["share"] = (
        race_era_tab
        .groupby("era")["n"]
        .apply(lambda x: x / x.sum())
        .values
    )

    print("\n=== Table 4.1 ‚Äì R√©partition raciale par √®re (si race disponible dans desc_df) ===")
    display(race_era_tab)

    race_path = os.path.join(out_dir, "table_4_1_race_share_by_era.csv")
    race_era_tab.to_csv(race_path, index=False)
    print("Table 4.1 sauvegard√©e dans :", race_path)

else:
    print("‚ö†Ô∏è Aucune colonne de race trouv√©e dans desc_df ‚Äì pas de Table 4.1 sur pr√©-IA.")
    # On propose, √† d√©faut, une table race uniquement sur IA via ai_acs si possible
    if "derived_race" in ai_acs.columns:
        race_ia_only = (
            ai_acs
            .dropna(subset=["derived_race"])
            .groupby("derived_race")\
            .size()\
            .reset_index(name="n")
        )
        race_ia_only["share"] = race_ia_only["n"] / race_ia_only["n"].sum()
        print("\n=== Table 4.1 (alternative) ‚Äì R√©partition raciale (IA uniquement, HMDA+ACS) ===")
        display(race_ia_only)

        race_ia_path = os.path.join(out_dir, "table_4_1_race_share_ia_only.csv")
        race_ia_only.to_csv(race_ia_path, index=False)
        print("Table 4.1 (IA only) sauvegard√©e dans :", race_ia_path)

# -------------------------------------------------------------------
# 4.1.2 Loan characteristics ‚Äì montants de pr√™ts par √®re
# -------------------------------------------------------------------

loan_amount_cols = [c for c in ["loan_amount", "loan_amount_000s", "loan_amount_clean"] if c in desc_df.columns]
if loan_amount_cols:
    loan_amount_col = loan_amount_cols[0]
    print(f"\nVariable de montant utilis√©e : {loan_amount_col}")

    loan_stats = (
        desc_df
        .groupby("era")[loan_amount_col]
        .agg(["count", "mean", "median", "std", "min", "max"])
        .reset_index()
    )

    print("\n=== Table 4.2 ‚Äì Statistiques descriptives des montants de pr√™ts par √®re ===")
    display(loan_stats)

    loan_path = os.path.join(out_dir, "table_4_2_loan_amount_stats_by_era.csv")
    loan_stats.to_csv(loan_path, index=False)
    print("Table 4.2 sauvegard√©e dans :", loan_path)
else:
    print("‚ö†Ô∏è Aucune colonne de montant de pr√™t trouv√©e dans desc_df ‚Äì Table 4.2 non g√©n√©r√©e.")

# -------------------------------------------------------------------
# 4.1.3 Approval outcomes ‚Äì taux d‚Äôapprobation / refus par √®re
# -------------------------------------------------------------------

if "approved" in desc_df.columns:
    approval_by_era = (
        desc_df
        .groupby("era")["approved"]
        .mean()
        .reset_index()
        .rename(columns={"approved": "approval_rate"})
    )

    print("\n=== Table 4.3 ‚Äì Taux d‚Äôapprobation moyen par √®re ===")
    display(approval_by_era)

    appr_path = os.path.join(out_dir, "table_4_3_approval_rate_by_era.csv")
    approval_by_era.to_csv(appr_path, index=False)
    print("Table 4.3 sauvegard√©e dans :", appr_path)

    # Si action_taken disponible, on donne une distribution plus fine
    action_cols = [c for c in ["action_taken", "action_taken_name"] if c in desc_df.columns]
    if action_cols:
        action_col = action_cols[0]
        action_tab = (
            desc_df
            .groupby(["era", action_col])
            .size()
            .reset_index(name="n")
        )
        action_tab["share"] = (
            action_tab
            .groupby("era")["n"]
            .apply(lambda x: x / x.sum())
            .values
        )

        print("\n=== Table 4.4 ‚Äì R√©partition de action_taken par √®re ===")
        display(action_tab)

        action_path = os.path.join(out_dir, "table_4_4_action_taken_by_era.csv")
        action_tab.to_csv(action_path, index=False)
        print("Table 4.4 sauvegard√©e dans :", action_path)
    else:
        print("‚ö†Ô∏è Pas de colonne 'action_taken' ‚Äì Table 4.4 non g√©n√©r√©e.")
else:
    print("‚ö†Ô∏è Colonne 'approved' absente ‚Äì impossible de construire les taux d‚Äôapprobation par √®re.")

desc_df shape : (14081220, 19)
Colonnes disponibles dans desc_df : ['action_taken', 'applicant_sex', 'county_code', 'hoepa_status', 'lien_status', 'loan_purpose', 'loan_type', 'preapproval', 'purchaser_type', 'rate_spread', 'state_code', 'year', 'approved', 'era', 'census_tract', 'geoid_tract', 'loan_amount', 'derived_ethnicity', 'derived_race']

=== Table 4.1 ‚Äì R√©partition raciale par √®re (si race disponible dans desc_df) ===
era	derived_race	n	share
0	IA	2 or more minority races	721	0.001266
1	IA	American Indian or Alaska Native	1552	0.002725
2	IA	Asian	42546	0.074708
3	IA	Black or African American	37418	0.065703
4	IA	Free Form Text Only	228	0.000400
5	IA	Joint	8620	0.015136
6	IA	Native Hawaiian or Other Pacific Islander	974	0.001710
7	IA	Race Not Available	127945	0.224662
8	IA	White	349496	0.613689
Table 4.1 sauvegard√©e dans : C:\Users\33669\OneDrive\–î–æ–∫—É–º–µ–Ω—Ç—ã\data_credit_scoring\tri_state_ai\data_work\tables\table_4_1_race_share_by_era.csv

Variable de montant utilis√©e : loan_amount

=== Table 4.2 ‚Äì Statistiques descriptives des montants de pr√™ts par √®re ===
era	count	mean	median	std	min	max
0	IA	569500	351651.044776	255000.0	1.393519e+06	5000.0	611455000.0
1	pre_IA	0	NaN	NaN	NaN	NaN	NaN
Table 4.2 sauvegard√©e dans : C:\Users\33669\OneDrive\–î–æ–∫—É–º–µ–Ω—Ç—ã\data_credit_scoring\tri_state_ai\data_work\tables\table_4_2_loan_amount_stats_by_era.csv

=== Table 4.3 ‚Äì Taux d‚Äôapprobation moyen par √®re ===
era	approval_rate
0	IA	0.542334
1	pre_IA	0.706809
Table 4.3 sauvegard√©e dans : C:\Users\33669\OneDrive\–î–æ–∫—É–º–µ–Ω—Ç—ã\data_credit_scoring\tri_state_ai\data_work\tables\table_4_3_approval_rate_by_era.csv

=== Table 4.4 ‚Äì R√©partition de action_taken par √®re ===
era	action_taken	n	share
0	IA	1.0	308859	0.542334
1	IA	2.0	11232	0.019723
2	IA	3.0	70324	0.123484
3	IA	4.0	68694	0.120622
4	IA	5.0	25257	0.044349
5	IA	6.0	84357	0.148125
6	IA	7.0	290	0.000509
7	IA	8.0	487	0.000855
8	pre_IA	1.0	6298523	0.466153
9	pre_IA	2.0	677153	0.050116
10	pre_IA	3.0	2574527	0.190540
11	pre_IA	4.0	1302967	0.096432
12	pre_IA	5.0	497787	0.036841
13	pre_IA	6.0	2158740	0.159768
14	pre_IA	7.0	1132	0.000084
15	pre_IA	8.0	891	0.000066
Table 4.4 sauvegard√©e dans : C:\Users\33669\OneDrive\–î–æ–∫—É–º–µ–Ω—Ç—ã\data_credit_scoring\tri_state_ai\data_work\tables\table_4_4_action_taken_by_era.csv
4.X Commentaires sur les descriptifs ‚Äì applicant, loans, approval (Tables 4.1‚Äì4.4)
4.X.1 R√©partition raciale dans la cohorte IA (Table 4.1)
La Table 4.1 d√©crit la composition raciale de la cohorte IA (2018‚Äì2023) √† partir de derived_race :

Groupe racial	Part dans l‚Äô√©chantillon IA
White	‚âà 61,4 %
Race Not Available	‚âà 22,5 %
Asian	‚âà 7,5 %
Black or African American	‚âà 6,6 %
Joint	‚âà 1,5 %
Native Hawaiian or Other Pacific Islander (NHOPI)	‚âà 0,17 %
American Indian or Alaska Native	‚âà 0,27 %
2 or more minority races	‚âà 0,13 %
Free Form Text Only	‚âà 0,04 %
Lecture :

La cohorte IA est majoritairement White (un peu plus de 60 %), ce qui reste coh√©rent avec la structure d√©mographique globale des dossiers HMDA sur la p√©riode r√©cente.
La proportion de dossiers avec race non renseign√©e (Race Not Available) est tr√®s √©lev√©e (‚âà 22‚Äì23 %), ce qui souligne un d√©ficit de compl√©tude et limite la granularit√© de certaines analyses fines par sous-groupes.
Les emprunteurs Black et Asian repr√©sentent respectivement environ 6,6 % et 7,5 % de l‚Äô√©chantillon IA, ce qui permettra n√©anmoins des analyses de fairness relativement stables sur ces groupes.
Les autres cat√©gories (NHOPI, American Indian, 2+ minority races, Free Form Text Only) restent num√©riquement faibles et devront √™tre interpr√©t√©es avec prudence dans les sections de fairness (risk of small-sample noise).
Dans le texte de la th√®se, on peut insister sur le fait que la mont√©e en granularit√© de HMDA post-2018 s‚Äôaccompagne encore d‚Äôun volume substantiel de donn√©es manquantes sur la race, ce qui constitue un enjeu m√©thodologique majeur pour l‚Äô√©valuation de la fairness.

4.X.2 Caract√©ristiques des montants de pr√™ts (Table 4.2)
La Table 4.2 pr√©sente les statistiques descriptives des montants de pr√™ts (loan_amount) par √®re :

√àre	n (count)	Moyenne (mean)	M√©diane	√âcart-type (std)	Min	Max
IA	569 500	‚âà 351 651	255 000	‚âà 1,39√ó10‚Å∂	5 000	611 455 000
pre-IA	0	NaN	NaN	NaN	NaN	NaN
Lecture :

Pour la cohorte IA, le montant moyen de pr√™t se situe autour de 351 k√©
 :
Cela refl√®te un march√© o√π les pr√™ts restent concentr√©s sur des montants interm√©diaires (‚âà 250‚Äì300 k√™√®√©√©
), d‚Äôo√π l‚Äô√©cart-type extr√™mement large.
Pour la cohorte pr√©-IA, aucune statistique n‚Äôest report√©e (count = 0) pour loan_amount :
Cela indique que la colonne loan_amount n‚Äôest pas disponible ou pas renseign√©e dans le jeu pre_ai dans sa forme actuelle.
Ce point devra √™tre mentionn√© dans le texte comme une limitation de comparabilit√© inter-√®re sur les montants (√©volution du sch√©ma HMDA, changements d‚Äôunit√©s ou de codage, etc.).
Pour la r√©daction, on pourra pr√©ciser que l‚Äôanalyse des montants de pr√™ts est principalement document√©e pour l‚Äô√®re IA, la p√©riode pr√©-IA √©tant moins exploitable sur cette dimension en raison d‚Äôun sch√©ma de donn√©es divergent ou incomplet.

4.X.3 Taux d‚Äôapprobation moyens par √®re (Table 4.3)
La Table 4.3 mesure le taux d‚Äôapprobation moyen (approved binaire) par √®re :

√àre	Taux d‚Äôapprobation moyen
IA	0,5423 (‚âà 54,2 %)
pre-IA	0,7068 (‚âà 70,7 %)
Lecture :

En p√©riode pr√©-IA (2007‚Äì2017), environ 70‚Äì71 % des dossiers de l‚Äô√©chantillon sont approuv√©s.
En p√©riode IA (2018‚Äì2023), le taux d‚Äôapprobation moyen tombe √† 54‚Äì55 %.
La diff√©rence brute de niveau est donc d‚Äôenviron ‚àí16 points de pourcentage, ce qui sugg√®re :
soit un durcissement g√©n√©ral du processus d‚Äôoctroi (plus de s√©lectivit√©, changement de cycle macro√©conomique),
soit un effet de recomposition de l‚Äô√©chantillon HMDA et de la d√©finition de l‚Äôindicateur approved.
Cette diff√©rence brute est ensuite r√©-analys√©e dans le cadre du PSM (Section PSM.1‚Äì3) et des mod√®les logit, afin de distinguer ce qui rel√®ve d‚Äôun effet structurel (composition diff√©rente des dossiers) de ce qui pourrait s‚Äôapparenter √† un effet sp√©cifique de l‚Äô√®re IA.

4.X.4 R√©partition fine de action_taken par √®re (Table 4.4)
La Table 4.4 d√©taille la distribution de action_taken (d√©cision HMDA) par √®re :

Pr√©-IA (2007‚Äì2017)
action_taken	Part dans pre-IA
1.0	46,6 %
2.0	5,0 %
3.0	19,1 %
4.0	9,6 %
5.0	3,7 %
6.0	16,0 %
7.0	‚âà 0,01 %
8.0	‚âà 0,01 %
IA (2018‚Äì2023)
action_taken	Part dans IA
1.0	54,2 %
2.0	2,0 %
3.0	12,3 %
4.0	12,1 %
5.0	4,4 %
6.0	14,8 %
7.0	0,05 %
8.0	0,09 %
(La signification exacte des codes 1‚Äì8 suit la nomenclature HMDA : pr√™ts origin√©s, refus√©s, retir√©s, incomplets, etc. Cette correspondance sera rappel√©e en note ou en annexe.)

Lecture :

Pour les deux √®res, les statuts 1.0 et 6.0 (origination / purchased, selon HMDA) concentrent une grande partie des dossiers.
La part de action_taken = 1.0 (typiquement pr√™ts accord√©s/origin√©s) :
passe d‚Äôenviron 46,6 % pre-IA √† 54,2 % IA,
alors que le taux d‚Äôapprobation moyen (Table 4.3) baisse de 70,7 % √† 54,2 % :
ce d√©calage indique que approved ne co√Øncide pas strictement avec une seule modalit√© action_taken (il agr√®ge potentiellement plusieurs codes ou filtrages sp√©cifiques √† l‚Äô√©chantillon).
Les cat√©gories 3.0 et 4.0 (retraits, incomplets, etc.) restent non n√©gligeables dans les deux p√©riodes (‚âà 19 % + 9,6 % pre-IA ; ‚âà 12,3 % + 12,1 % IA), ce qui souligne l‚Äôimportance de contraintes non purement ‚Äúaccept√©/refus√©‚Äù dans le pipeline d‚Äôoctroi (retraits volontaires, dossiers incomplets, etc.).
En synth√®se, la Table 4.4 montre que la structure de action_taken reste relativement stable entre les deux √®res, tout en sugg√©rant des d√©placements modestes entre les cat√©gories. Combin√©e √† la baisse du taux d‚Äôapprobation moyen, cette distribution met en √©vidence un paysage d‚Äôoctroi plus complexe que le simple binaire ‚Äúapprove/deny‚Äù, o√π la part de dossiers retir√©s ou incomplets joue un r√¥le non trivial.

4.X.5 Synth√®se pour la section descriptive du Chapter 4
La cohorte IA pr√©sente une composition raciale domin√©e par les Whites, mais avec une proportion tr√®s √©lev√©e de dossiers √† race manquante, ce qui constitue une limite m√©thodologique essentielle pour l‚Äôanalyse de fairness.
Les montants de pr√™ts ne sont pleinement observables que pour l‚Äô√®re IA, ce qui impose de traiter la comparaison inter-√®re avec prudence sur ce volet.
Les taux d‚Äôapprobation bruts diff√®rent fortement entre les deux p√©riodes (‚âà 71 % vs 54 %), motivant l‚Äôusage des approches de type PSM et logits pour d√©m√™ler effets de composition et effets potentiels de l‚Äô√®re IA.
La structure d√©taill√©e de action_taken indique que l‚Äôoctroi ne se r√©duit pas √† un simple sch√©ma binaire, mais implique des d√©cisions interm√©diaires (retraits, dossiers incomplets) qui doivent √™tre prises en compte dans l‚Äôinterpr√©tation.
Ces √©l√©ments descriptifs fournissent le socle empirique de la Section 4.1‚Äì4.3, sur lequel viennent ensuite se greffer les analyses plus avanc√©es (PSM, ML cross-era, fairness, sous-groupes).
"